<!doctype html>
<html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dashboard ‚Äî LoveNote AI</title>
<link rel="stylesheet" href="./css/style.css"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head><body>
<div class="container">
  <div class="nav">
    <div class="brand"><a href="./index.html" style="text-decoration:none">üíò LoveNote AI</a> <span class="badge" id="paidBadge">Locked</span></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn ghost" id="logoutBtn">Logout</button>
      <a class="btn primary" href="./upsell.html">Dancing Upsell</a>
    </div>
  </div>

  <div class="grid4">
    <!-- AI Message Generator -->
    <div class="pinkCard" id="wrap-msg">
      <div class="lock" id="lock-msg">LOCKED</div>
      <div class="pinkCardInner">
        <div class="cardTitle"><h2>*AI Message Generator*</h2><span class="badge">‚Ä¢‚Ä¢‚Ä¢</span></div>
        <div class="cardBody">
          <img class="cardShot" id="img-msg" alt="AI Message"/>
          <div>
            <div class="field"><label>Recipient‚Äôs Name</label><input id="msg_name" placeholder="Emma"/></div>
            <div class="field"><label>Type of Message</label>
              <select id="msg_tone"><option>Romantic</option><option>Cute</option><option>Funny</option></select>
            </div>
            <div class="field"><label>Choose Image</label><input id="msg_file" type="file" accept="image/*"/></div>
            <button class="bigBtn" id="msg_send">Send Message</button>
            <div class="previewBox" id="msg_preview" style="display:none"></div>
            <div class="subActions">
              <button class="chip" id="msg_copy">Copy</button>
              <button class="chip" id="msg_sms">Send to Phone</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Meme Creator -->
    <div class="pinkCard" id="wrap-meme">
      <div class="lock" id="lock-meme">LOCKED</div>
      <div class="pinkCardInner">
        <div class="cardTitle"><h2>*Meme Creator*</h2><span class="badge">‚â°</span></div>
        <div class="cardBody">
          <img class="cardShot" id="img-meme" alt="Meme Creator"/>
          <div>
            <div class="field"><label>Top Text</label><input id="meme_top" placeholder="When you find your paw-fect match‚Ä¶"/></div>
            <div class="field"><label>Bottom Text</label><input id="meme_bottom" placeholder="‚Ä¶so you post it everywhere üíò"/></div>
            <div class="field"><label>Upload Photo</label><input id="meme_file" type="file" accept="image/*"/></div>
            <button class="bigBtn" id="meme_gen">Generate Meme</button>
            <div class="previewBox">
              <div class="canvasWrap"><canvas id="meme_canvas" width="640" height="420"></canvas></div>
              <div class="subActions">
                <button class="chip" id="meme_download">Download</button>
                <button class="chip" id="meme_send">Send</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Greeting Card Builder -->
    <div class="pinkCard" id="wrap-card">
      <div class="lock" id="lock-card">LOCKED</div>
      <div class="pinkCardInner">
        <div class="cardTitle"><h2>*Greeting Card Builder*</h2><span class="badge">‚ô°</span></div>
        <div class="cardBody">
          <img class="cardShot" id="img-card" alt="Greeting Card"/>
          <div>
            <div class="field"><label>Recipient‚Äôs Name</label><input id="card_name" placeholder="Jessie"/></div>
            <div class="field"><label>Card Message</label><textarea id="card_msg">You make my heart skip a beat! üíò</textarea></div>
            <div class="field"><label>Choose Image</label><input id="card_file" type="file" accept="image/*"/></div>
            <button class="bigBtn" id="card_create">‚ô° Create Card ‚ô°</button>
            <div class="subActions">
              <button class="chip" id="card_open">Open / Close Card</button>
              <a class="chip" href="./upsell.html">Dance Upsell</a>
              <button class="chip" id="card_snap">Download Snapshot PNG</button>
            </div>
            <div class="previewBox" id="card_preview">
              <div id="card_canvas_area" style="display:flex;justify-content:center">
                <div id="card_mock" style="width:320px;border-radius:22px;background:linear-gradient(180deg,#fff,#fff3fb);padding:16px;border:1px solid rgba(255,47,159,.20);box-shadow:0 16px 34px rgba(0,0,0,.10);transform-origin:center;transition:transform .35s ease">
                  <div style="text-align:center;font-weight:1000;color:#ff2f9f;font-size:20px;margin:4px 0 10px">Premium Greeting Card</div>
                  <div id="card_img_slot" style="height:160px;border-radius:18px;background:#fff;border:1px dashed rgba(255,47,159,.35);display:flex;align-items:center;justify-content:center;overflow:hidden">
                    <span style="color:#999;font-weight:800">Your image here</span>
                  </div>
                  <div style="margin-top:12px;background:#fff;border-radius:16px;padding:12px;border:1px solid rgba(0,0,0,.06)">
                    <div style="font-weight:900;margin-bottom:6px" id="card_to">To: Jessie</div>
                    <div style="white-space:pre-wrap" id="card_text"></div>
                  </div>
                </div>
              </div>
              <p class="notice">Tip: Click ‚ÄúOpen / Close Card‚Äù for the reveal animation.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Photo Transform -->
    <div class="pinkCard" id="wrap-photo">
      <div class="lock" id="lock-photo">LOCKED</div>
      <div class="pinkCardInner">
        <div class="cardTitle"><h2>*Photo Transform*</h2><span class="badge">‚ú¶</span></div>
        <div class="cardBody">
          <img class="cardShot" id="img-photo" alt="Photo Transform"/>
          <div>
            <div class="field"><label>Select</label>
              <select id="photo_style"><option value="dreamy">Dreamy Romantic</option><option value="warm">Warm Glow</option><option value="bold">Bold Pop</option></select>
            </div>
            <div class="field"><label>Upload Photo</label><input id="photo_file" type="file" accept="image/*"/></div>
            <button class="bigBtn" id="photo_go">Transform Photo</button>
            <div class="previewBox">
              <div id="photo_preview" style="border-radius:18px;overflow:hidden;border:1px solid rgba(0,0,0,.06);background:#fff;min-height:200px;display:flex;align-items:center;justify-content:center">
                <span style="color:#999;font-weight:900">Preview</span>
              </div>
              <div class="subActions">
                <button class="chip" id="photo_download">Download</button>
                <button class="chip" id="photo_send">Send</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <div class="footer">Locked badge is controlled by <b>localStorage.lovenote_paid</b>. Replace with Stripe validation on success.</div>
</div>

<script type="module">
  import { supabase } from "./js/supabase.js";
  import { requireAuth } from "./js/guard.js";
  import { IMG, toast, dataURLFromFile, openSMS, downloadDataUrl, qs } from "./js/common.js";

  // Set card images (prevents broken placeholders)
  qs("#img-msg").src = IMG.msg;
  qs("#img-meme").src = IMG.meme;
  qs("#img-card").src = IMG.card;
  qs("#img-photo").src = IMG.photo;

  await requireAuth();

  const paid = (localStorage.getItem("lovenote_paid") === "true");
  paidBadge.textContent = paid ? "Unlocked" : "Locked";
  paidBadge.style.color = paid ? "#0a7" : "#a00";
  ["msg","meme","card","photo"].forEach(k => { if(!paid) qs("#lock-"+k).classList.add("show"); });

  logoutBtn.onclick = async ()=>{ await supabase.auth.signOut(); localStorage.removeItem("lovenote_paid"); location.href="./index.html"; };

  // AI MESSAGE
  const msgPreview = qs("#msg_preview");
  function buildMessage(){
    const name = qs("#msg_name").value.trim() || "My Favorite Person";
    const tone = qs("#msg_tone").value;
    return ({
      Romantic: `Roses are red\nViolets are blue\nI used LoveNote AI‚Ä¶\nso this message is REALLY true üò≠üíò\n\n‚Äî ${name}`,
      Cute: `Hey ${name}!\nJust a reminder: you‚Äôre adorable ü•∞üíò`,
      Funny: `${name},\nIf loving you is wrong‚Ä¶\nthen I don‚Äôt wanna be right üò≠üíò`
    })[tone];
  }
  msg_send.onclick = ()=>{ if(!paid) return toast("Locked ‚Äî purchase to unlock."); msgPreview.style.display="block"; msgPreview.textContent = buildMessage(); toast("Message generated."); };
  msg_copy.onclick = async ()=>{ const m = msgPreview.textContent || buildMessage(); await navigator.clipboard.writeText(m); toast("Copied!"); };
  msg_sms.onclick = ()=> openSMS(msgPreview.textContent || buildMessage());

  // MEME
  const memeCanvas = qs("#meme_canvas"), mctx = memeCanvas.getContext("2d");
  let memeImg = null;
  function drawMeme(){
    mctx.clearRect(0,0,memeCanvas.width,memeCanvas.height);
    mctx.fillStyle="#fff"; mctx.fillRect(0,0,memeCanvas.width,memeCanvas.height);
    if(!memeImg){
      const ph = new Image(); ph.onload=()=>{memeImg=ph; drawMeme();}; ph.src=IMG.meme; return;
    }
    const cw=memeCanvas.width,ch=memeCanvas.height, iw=memeImg.width,ih=memeImg.height;
    const s=Math.max(cw/iw,ch/ih), nw=iw*s, nh=ih*s, x=(cw-nw)/2, y=(ch-nh)/2;
    mctx.drawImage(memeImg,x,y,nw,nh);
    const top=(meme_top.value||"").trim(), bottom=(meme_bottom.value||"").trim();
    mctx.font="900 34px system-ui"; mctx.textAlign="center"; mctx.fillStyle="white"; mctx.strokeStyle="rgba(0,0,0,.75)"; mctx.lineWidth=8;
    const tl=(t,y)=>{ if(!t) return; mctx.strokeText(t,cw/2,y); mctx.fillText(t,cw/2,y); };
    tl(top,52); tl(bottom,ch-22);
  }
  drawMeme();
  meme_file.onchange = async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const url=await dataURLFromFile(f); const im=new Image(); im.onload=()=>{memeImg=im; drawMeme();}; im.src=url; };
  meme_gen.onclick = ()=>{ if(!paid) return toast("Locked ‚Äî purchase to unlock."); drawMeme(); toast("Meme generated."); };
  meme_download.onclick = ()=> downloadDataUrl(memeCanvas.toDataURL("image/png"), "lovenote-meme.png");
  meme_send.onclick = ()=> openSMS("Here‚Äôs your LoveNote AI meme üíò");

  // CARD BUILDER
  let cardOpen=false;
  card_create.onclick = ()=>{ if(!paid) return toast("Locked ‚Äî purchase to unlock."); card_to.textContent="To: "+(card_name.value.trim()||"My Favorite Person"); card_text.textContent=card_msg.value||""; toast("Card ready!"); };
  card_open.onclick = ()=>{ if(!paid) return toast("Locked ‚Äî purchase to unlock."); cardOpen=!cardOpen; card_mock.style.transform = cardOpen ? "rotateX(10deg) scale(1.02)" : "none"; toast(cardOpen?"Opened!":"Closed!"); };
  card_file.onchange = async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const url=await dataURLFromFile(f); card_img_slot.innerHTML=""; const im=new Image(); im.src=url; im.style.width="100%"; im.style.height="100%"; im.style.objectFit="cover"; card_img_slot.appendChild(im); };
  card_snap.onclick = async ()=>{ if(!paid) return toast("Locked ‚Äî purchase to unlock."); const c=await html2canvas(card_canvas_area,{backgroundColor:null,scale:2}); downloadDataUrl(c.toDataURL("image/png"),"lovenote-card.png"); };

  // PHOTO
  const photoPrev = qs("#photo_preview"); let photoUrl=null;
  function applyPhotoStyle(){
    if(!photoUrl) return;
    const mode=photo_style.value;
    const filter={dreamy:"saturate(1.05) contrast(1.05) brightness(1.06) hue-rotate(330deg)",warm:"saturate(1.2) contrast(1.08) brightness(1.03) sepia(.18)",bold:"saturate(1.4) contrast(1.22) brightness(1.02)"}[mode]||"none";
    photoPrev.innerHTML = `<img src="${photoUrl}" style="width:100%;display:block;filter:${filter}">`;
  }
  photo_file.onchange = async (e)=>{ const f=e.target.files?.[0]; if(!f) return; photoUrl=await dataURLFromFile(f); applyPhotoStyle(); };
  photo_go.onclick = ()=>{ if(!paid) return toast("Locked ‚Äî purchase to unlock."); applyPhotoStyle(); toast("Transformed!"); };
  photo_download.onclick = async ()=>{ const c=await html2canvas(photoPrev,{backgroundColor:null,scale:2}); downloadDataUrl(c.toDataURL("image/png"),"lovenote-photo.png"); };
  photo_send.onclick = ()=> openSMS("LoveNote AI photo transform is ready üíò");
</script>
</body></html>
