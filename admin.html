<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LoveNote AI ‚Äî Owner Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --hot:#ff1493;
  --hot2:#ff4dc4;
  --ink:#111;
  --muted:#666;
  --bg:#ffffff;
  --soft:#fff0fb;
  --card:#ffffff;
  --shadow:0 18px 45px rgba(0,0,0,.14);
  --radius:22px;
}
*{box-sizing:border-box}
body{margin:0;font-family:'Poppins',system-ui,Segoe UI,Arial;background:var(--bg);color:var(--ink);}
a{color:inherit;text-decoration:none}
.container{max-width:1120px;margin:0 auto;padding:18px}
.btn{border:none;cursor:pointer;border-radius:14px;padding:12px 16px;font-weight:800}
.btnHot{background:linear-gradient(90deg,var(--hot),var(--hot2));color:#fff}
.btnGhost{background:#fff;border:1px solid rgba(0,0,0,.12)}
.btnDark{background:#111;color:#fff}
.pill{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.85);border:1px solid rgba(0,0,0,.08)}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid rgba(0,0,0,.06);}
.grid{display:grid;gap:16px}
.grid2{grid-template-columns:1.1fr .9fr}
@media(max-width:980px){.grid2{grid-template-columns:1fr}}
.heroBand{background:linear-gradient(180deg,#ff00a8,#ff4dc4,#ff87d8);color:#fff}
.titleGlow{font-size:64px;line-height:1;font-weight:900;letter-spacing:.4px}
.sub{opacity:.92;font-size:18px}
small{color:var(--muted)}
hr{border:none;border-top:1px solid rgba(0,0,0,.08);margin:16px 0}
input,textarea,select{
  width:100%;padding:12px 12px;border-radius:14px;border:1px solid rgba(0,0,0,.14);
  font-family:inherit;font-size:14px;background:#fff;
}
textarea{min-height:110px;resize:vertical}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.kbd{font-size:12px;padding:4px 8px;border-radius:10px;background:rgba(0,0,0,.06)}
.badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,20,147,.12);color:#b00062;font-weight:800}
.lock{opacity:.55;filter:grayscale(1)}
.modalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
.modal{width:min(560px,92vw);background:#fff;border-radius:22px;box-shadow:0 28px 80px rgba(0,0,0,.35);padding:18px}
.table{width:100%;border-collapse:separate;border-spacing:0 10px}
.table td{padding:12px 10px;background:#fff;border-top:1px solid rgba(0,0,0,.06);border-bottom:1px solid rgba(0,0,0,.06)}
.table tr td:first-child{border-left:1px solid rgba(0,0,0,.06);border-top-left-radius:14px;border-bottom-left-radius:14px}
.table tr td:last-child{border-right:1px solid rgba(0,0,0,.06);border-top-right-radius:14px;border-bottom-right-radius:14px}
</style>
</head>
<body>

<header class="heroBand">
  <div class="container row" style="justify-content:space-between">
    <div class="row">
      <div class="pill">üõ°Ô∏è <b>Owner Admin</b> <span class="kbd">Phase 2</span></div>
      <div class="pill" id="adminStatus">Checking access...</div>
    </div>
    <div class="row">
      <button class="btn btnGhost" onclick="location.href='index.html'">Landing</button>
      <button class="btn btnGhost" onclick="location.href='dashboard.html'">Dashboard</button>
      <button class="btn btnHot" onclick="logout()">Logout</button>
    </div>
  </div>
</header>

<main class="container" style="margin-top:12px">
  <div class="grid grid2">
    <div class="card" style="padding:16px">
      <h2 style="margin:0;color:#b00062">Users</h2>
      <small>Search by email and set plan. This is Phase 2 activation (after Stripe payment link purchase).</small>
      <hr/>
      <div class="row">
        <input id="search" placeholder="Search email (e.g. customer@email.com)" style="flex:1"/>
        <button class="btn btnDark" onclick="searchUsers()">Search</button>
      </div>
      <div id="userResults" style="margin-top:12px"></div>
    </div>

    <div class="card" style="padding:16px">
      <h2 style="margin:0;color:#b00062">Analytics</h2>
      <small>Simple metrics from the database.</small>
      <hr/>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
        <div class="card" style="padding:14px">
          <div class="badge">üë• Total Users</div>
          <div style="font-size:36px;font-weight:900;margin-top:8px" id="mUsers">‚Äî</div>
        </div>
        <div class="card" style="padding:14px">
          <div class="badge">‚ú® Total Creations</div>
          <div style="font-size:36px;font-weight:900;margin-top:8px" id="mCreations">‚Äî</div>
        </div>
        <div class="card" style="padding:14px">
          <div class="badge">üíò Pro Users</div>
          <div style="font-size:36px;font-weight:900;margin-top:8px" id="mPro">‚Äî</div>
        </div>
      </div>
      <hr/>
      <button class="btn btnHot" onclick="refreshMetrics()">Refresh Metrics</button>
    </div>
  </div>
</main>

<script>
const CONFIG = {
  SUPABASE_URL: "https://xsrgfbhxhavasrjscaik.supabase.co",
  SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzcmdmYmh4aGF2YXNyanNjYWlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MzQ2NDEsImV4cCI6MjA4NjQxMDY0MX0.qOTtfazgB6deUpgaZPoCvPWYVRMDQ0CWhkYxDXhr88g",
};
const supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

let user = null;
let profile = null;

async function requireOwner(){
  const { data: s } = await supabase.auth.getSession();
  user = s?.session?.user || null;
  if(!user){ alert("Login first."); location.href='index.html'; return; }

  const { data: prof, error } = await supabase
    .from('profiles')
    .select('user_id,email,role,plan')
    .eq('user_id', user.id)
    .maybeSingle();

  if(error){ alert(error.message); location.href='index.html'; return; }
  profile = prof;

  if(!profile || profile.role !== 'owner'){
    alert("Owner only. Set your role='owner' in public.profiles.");
    location.href='dashboard.html';
    return;
  }
  document.getElementById('adminStatus').textContent = `Owner: ${profile.email} (plan: ${profile.plan})`;
  refreshMetrics();
}

function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

async function searchUsers(){
  const q = document.getElementById('search').value.trim();
  if(!q){ alert("Type an email search."); return; }

  const { data, error } = await supabase
    .from('profiles')
    .select('user_id,email,role,plan,created_at')
    .ilike('email', `%${q}%`)
    .limit(25);

  if(error){ alert(error.message); return; }
  if(!data || data.length===0){
    document.getElementById('userResults').innerHTML = `<small>No matches.</small>`;
    return;
  }

  document.getElementById('userResults').innerHTML = data.map(u => `
    <div class="card" style="padding:12px;margin-bottom:10px">
      <div class="row" style="justify-content:space-between">
        <b>${escapeHtml(u.email)}</b>
        <small>${new Date(u.created_at).toLocaleDateString()}</small>
      </div>
      <div class="row" style="margin-top:8px">
        <span class="badge">role: ${escapeHtml(u.role)}</span>
        <span class="badge">plan: ${escapeHtml(u.plan)}</span>
      </div>
      <div class="row" style="margin-top:10px">
        <select id="plan_${u.user_id}" style="flex:1">
          <option value="free" ${u.plan==='free'?'selected':''}>free</option>
          <option value="bundle" ${u.plan==='bundle'?'selected':''}>bundle</option>
          <option value="pro" ${u.plan==='pro'?'selected':''}>pro</option>
        </select>
        <button class="btn btnHot" onclick="setPlan('${u.user_id}')">Set Plan</button>
      </div>
      <div class="row" style="margin-top:8px">
        <select id="role_${u.user_id}" style="flex:1">
          <option value="user" ${u.role==='user'?'selected':''}>user</option>
          <option value="owner" ${u.role==='owner'?'selected':''}>owner</option>
        </select>
        <button class="btn btnDark" onclick="setRole('${u.user_id}')">Set Role</button>
      </div>
    </div>
  `).join('');
}

async function setPlan(user_id){
  const plan = document.getElementById(`plan_${user_id}`).value;
  const { error } = await supabase.from('profiles').update({ plan }).eq('user_id', user_id);
  if(error){ alert(error.message); return; }
  alert("Plan updated ‚úÖ");
  refreshMetrics();
}

async function setRole(user_id){
  const role = document.getElementById(`role_${user_id}`).value;
  const { error } = await supabase.from('profiles').update({ role }).eq('user_id', user_id);
  if(error){ alert(error.message); return; }
  alert("Role updated ‚úÖ");
}

async function refreshMetrics(){
  // total users
  const users = await supabase.from('profiles').select('user_id', { count: 'exact', head: true });
  const creations = await supabase.from('creations').select('id', { count: 'exact', head: true });
  const pro = await supabase.from('profiles').select('user_id', { count: 'exact', head: true }).eq('plan','pro');

  document.getElementById('mUsers').textContent = users.count ?? '‚Äî';
  document.getElementById('mCreations').textContent = creations.count ?? '‚Äî';
  document.getElementById('mPro').textContent = pro.count ?? '‚Äî';
}

async function logout(){
  await supabase.auth.signOut();
  location.href='index.html';
}

requireOwner();
</script>
</body></html>
